<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>80°エルボ・距離計算ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --ios-bg: #000000;
            --ios-card: #1c1c1e;
            --ios-border: #333333;
            --ios-orange: #ff9f0a;
            --accent-80: #af52de;
            --accent-80leg: #007aff;
            --accent-dist: #30d158;
            --ios-silver: #c7c7cc;
            --ios-silver-dark: #9a9a9e;
            --label-gray: #b0b0b5;
        }

        * {
            box-sizing: border-box;
            -webkit-text-size-adjust: 100%;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            background: var(--ios-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* 3D立体タブ */
        .tab-wrapper {
            position: sticky;
            top: 0;
            z-index: 100;
            width: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            padding: 6px 0;
            display: flex;
            justify-content: center;
            border-bottom: 1px solid #222;
        }

        .tab-container {
            display: flex;
            background: #2c2c2e;
            width: 95%;
            max-width: 420px;
            padding: 3px;
            border-radius: 14px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
            border: 1px solid #3a3a3c;
        }

        .tab-button {
            flex: 1;
            padding: 9px 0;
            border: 1px solid transparent;
            background: transparent;
            color: var(--ios-silver-dark);
            font-size: 13px;
            font-weight: 600; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 11px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab-button.active {
            background: linear-gradient(180deg, #636366 0%, #48484a 100%);
            border: 1px solid #7c7c80;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.15);
            transform: translateY(-1px);
        }

        /* モード別文字色 */
        .mode-80 #nav-80.active { color: #d697ff; }
        .mode-80leg #nav-80leg.active { color: #72b5ff; }
        .mode-dist #nav-dist.active { color: #63ff8b; }

        .main-container {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
        }

        /* 独立した結果枠 */
        .result-box {
            height: 64px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            margin: 10px;
            border: 1.5px solid var(--ios-border);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: background 0.3s, transform 0.1s;
        }
        .result-box:active { transform: scale(0.98); }

        .mode-80 .result-box-main { background: var(--accent-80); border-color: var(--accent-80); }
        .mode-80leg .result-box-main { background: var(--accent-80leg); border-color: var(--accent-80leg); }
        .mode-dist .result-box-main { background: var(--accent-dist); border-color: var(--accent-dist); }

        /* セル形式グリッド */
        .cell-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            background: var(--ios-border);
            gap: 1px;
            border-bottom: 1px solid var(--ios-border);
            border-top: 1px solid var(--ios-border);
        }

        .calc-cell {
            background: #121214;
            height: 53px;
            padding: 0 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            grid-column: span 3;
        }

        .calc-cell-sm { height: 46px; }
        
        .span-6 { grid-column: span 6 !important; }
        .span-4 { grid-column: span 4 !important; }
        .span-2 { grid-column: span 2 !important; }

        .calc-cell.focused {
            background: #1c1c1e;
            box-shadow: inset 0 0 0 2px var(--ios-orange);
            z-index: 10;
        }

        .input-value {
            font-size: 26px;
            font-weight: 700; 
            color: #ffffff;
            flex: 1;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .input-value-sm { font-size: 25px; }

        .result-value {
            font-size: 40px; 
            font-weight: 700; 
            color: #ffffff;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .input-label-left {
            font-size: 13px;
            font-weight: 700; 
            color: var(--label-gray);
            margin-right: 4px;
            white-space: nowrap;
            text-align: left;
        }

        .result-label-left {
            font-size: 13px;
            font-weight: 700; 
            color: #ffffff;
            text-align: left;
            line-height: 1.2;
        }

        select.input-value {
            background: transparent;
            border: none;
            outline: none;
            appearance: none;
            width: 100%;
            direction: rtl;
        }

        /* テンキー */
        .keypad-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: #000;
            padding: 1px;
        }

        .key-btn {
            background: #1c1c1e;
            color: white;
            border: none;
            height: 64px;
            font-size: 24px;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
        }
        .key-btn:active { background: #333; }
        .key-btn.orange { background: var(--ios-orange); font-weight: 700; } 
        .key-btn.gray { background: #2c2c2e; color: var(--label-gray); font-size: 18px; font-weight: 600; } 
        
        #delete-btn-label { font-size: 36px; line-height: 1; }
        .mode-dist #delete-btn-label { font-size: 18px; }

        /* 履歴・フッター */
        .history-area { background: #000; padding: 12px; }
        .history-header {
            font-size: 15px; 
            font-weight: 700; 
            color: var(--label-gray);
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-item {
            background: #111;
            border-bottom: 1px solid #222;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }
        .history-item.is-locked {
            border: 1px solid var(--ios-orange);
            background: #1c1c1e;
            border-radius: 8px;
            margin-bottom: 2px;
        }
        .lock-btn {
            padding: 10px;
            background: #1c1c1e;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .lock-btn.active { background: var(--ios-orange); color: white; }

        .app-footer-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 16px 4px 8px 4px;
            font-size: 13px;
            font-weight: 400; 
            color: #666666;
            letter-spacing: 0.05em;
        }

        .diagram-container {
            background: #09090b;
            padding: 15px;
            margin: 10px;
            border: 1px solid var(--ios-border);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        #toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(59, 130, 246, 0.95);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            opacity: 0;
            z-index: 1000;
            transition: 0.3s;
            pointer-events: none;
        }
        #toast.show { opacity: 1; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="mode-80">

    <div id="toast">コピーしました</div>

    <!-- 3D立体タブ -->
    <div class="tab-wrapper">
        <div class="tab-container">
            <button class="tab-button active" id="nav-80" onclick="switchTab('80')">80°エルボ</button>
            <button class="tab-button" id="nav-80leg" onclick="switchTab('80leg')">足付 80°</button>
            <button class="tab-button" id="nav-dist" onclick="switchTab('dist')">距離計算</button>
        </div>
    </div>

    <div class="main-container">
        <!-- 共通結果枠 -->
        <div class="result-box result-box-main" onclick="copyResult()">
            <div class="result-label-left" id="result-label">切寸法</div>
            <div class="result-value">
                <span id="result-val">---</span>
                <span class="text-sm font-bold opacity-70">mm</span>
            </div>
        </div>

        <!-- エルボパネル -->
        <div id="section-elbow">
            <div class="cell-grid">
                <div class="calc-cell calc-cell-sm">
                    <span class="input-label-left">サイズ</span>
                    <select id="elbow-size" class="input-value input-value-sm" onchange="elbowCalc()">
                        <option value="75">75</option>
                        <option value="100" selected>100</option>
                        <option value="125">125</option>
                    </select>
                </div>
                <div class="calc-cell calc-cell-sm" style="background: #0a0a0b;">
                    <span class="input-label-left">重寸法</span>
                    <span class="input-value text-zinc-500 input-value-sm" id="d-val">--</span>
                </div>
                <!-- 足(左・2/6) 寸法(右・4/6) = 1:2 比率 -->
                <div class="calc-cell span-2" id="cell-leg-input" style="display: none;" onclick="focusInput('leg-input')">
                    <span class="input-label-left">足</span>
                    <div id="leg-input" class="input-value">0</div>
                </div>
                <div class="calc-cell span-6 focused" id="cell-main-input" onclick="focusInput('main-input')">
                    <span class="input-label-left">寸法</span>
                    <div id="main-input" class="input-value">0</div>
                </div>
            </div>
        </div>

        <!-- 距離計算パネル -->
        <div id="section-dist" class="hidden">
            <div class="cell-grid">
                <div class="calc-cell calc-cell-sm" id="cell-dist-b" onclick="focusInput('dist-input-b')">
                    <span class="input-label-left">足長</span>
                    <div id="dist-input-b" class="input-value input-value-sm">0</div>
                </div>
                <div class="calc-cell calc-cell-sm">
                    <span class="input-label-left">選択</span>
                    <select id="dist-select-x" class="input-value input-value-sm" onchange="distCalc()">
                        <option value="45">75</option>
                        <option value="57" selected>100</option>
                        <option value="70">125</option>
                    </select>
                </div>
                <div class="calc-cell" id="cell-dist-h" onclick="focusInput('dist-input-h')">
                    <span class="input-label-left">直線距離</span>
                    <div id="dist-input-h" class="input-value">0</div>
                </div>
                <div class="calc-cell" id="cell-dist-a" onclick="focusInput('dist-input-a')">
                    <span class="input-label-left">移動寸法</span>
                    <div id="dist-input-a" class="input-value">0</div>
                </div>
            </div>
        </div>

        <!-- テンキー -->
        <div class="keypad-container">
            <button class="key-btn" onclick="pressKey('7')">7</button>
            <button class="key-btn" onclick="pressKey('8')">8</button>
            <button class="key-btn" onclick="pressKey('9')">9</button>
            <button class="key-btn gray" id="delete-btn-label" onclick="pressKey('backspace')">⇦</button>
            
            <button class="key-btn" onclick="pressKey('4')">4</button>
            <button class="key-btn" onclick="pressKey('5')">5</button>
            <button class="key-btn" onclick="pressKey('6')">6</button>
            <button class="key-btn gray" onclick="pressKey('clear')">AC</button>
            
            <button class="key-btn" onclick="pressKey('1')">1</button>
            <button class="key-btn" onclick="pressKey('2')">2</button>
            <button class="key-btn" onclick="pressKey('3')">3</button>
            <button class="key-btn orange row-span-2 h-full" id="enter-btn-label" onclick="pressKey('enter')">保存</button>
            
            <button class="key-btn" onclick="pressKey('0')">0</button>
            <button class="key-btn" onclick="pressKey('00')">00</button>
            <button class="key-btn" onclick="pressKey('.')">.</button>
        </div>

        <!-- 距離計算図面 -->
        <div id="dist-diagram-wrapper" class="diagram-container hidden">
            <svg viewBox="0 0 360 210" class="w-full h-auto" xmlns="http://www.w3.org/2000/svg">
                <!-- 管路本体 -->
                <line x1="100" y1="10" x2="160" y2="10" stroke="white" stroke-width="2" />
                <line x1="140" y1="10" x2="140" y2="25" stroke="white" stroke-width="2" />
                <circle cx="140" cy="45" r="16.2" fill="none" stroke="white" stroke-width="2" />
                <line x1="140" y1="45" x2="280" y2="125" stroke="white" stroke-width="3" />
                <rect x="175" y="60" width="80" height="34" rx="6" fill="black" stroke="white" stroke-width="1.5" />
                <text id="dist-diagram-result" x="215" y="84" fill="white" font-size="22" font-weight="700" text-anchor="middle">---</text>
                <circle cx="280" cy="125" r="16.2" fill="none" stroke="white" stroke-width="2" />

                <!-- 直線距離 寸法補助線と寸法線 -->
                <line x1="100" y1="10" x2="140" y2="10" stroke="#3b82f6" stroke-width="1" opacity="0.5" />
                <line x1="100" y1="125" x2="280" y2="125" stroke="#3b82f6" stroke-width="1" opacity="0.5" />
                <line x1="100" y1="10" x2="100" y2="125" stroke="#3b82f6" stroke-width="2.5" />
                <line x1="95" y1="10" x2="105" y2="10" stroke="#3b82f6" stroke-width="2.5" />
                <line x1="95" y1="125" x2="105" y2="125" stroke="#3b82f6" stroke-width="2.5" />
                <text x="5" y="75" fill="#3b82f6" font-size="16" font-weight="bold">直線距離</text>

                <!-- 移動寸法 寸法補助線と寸法線 -->
                <line x1="140" y1="45" x2="140" y2="155" stroke="#3b82f6" stroke-width="1" opacity="0.5" />
                <line x1="280" y1="125" x2="280" y2="155" stroke="#3b82f6" stroke-width="1" opacity="0.5" />
                <line x1="140" y1="155" x2="280" y2="155" stroke="#3b82f6" stroke-width="2.5" />
                <line x1="140" y1="150" x2="140" y2="160" stroke="#3b82f6" stroke-width="2.5" />
                <line x1="280" y1="150" x2="280" y2="160" stroke="#3b82f6" stroke-width="2.5" />
                <text x="210" y="195" fill="#3b82f6" font-size="16" font-weight="bold" text-anchor="middle">移動寸法</text>
            </svg>
        </div>

        <!-- 履歴・ロゴエリア -->
        <div id="history-area" class="history-area">
            <div id="history-content-wrapper">
                <div class="history-header">
                    <span>最近の計算履歴</span>
                    <button onclick="clearHistory()" class="text-red-600">履歴削除</button>
                </div>
                <div id="main-history-list"></div>
            </div>
            <div class="app-footer-bar">
                <span>80°エルボ・距離電卓</span>
                <span>KYOWA ROOF</span>
            </div>
        </div>
    </div>

<script>
    let currentTab = '80';
    let focusedInputId = 'main-input-80';
    let isOverwriteMode = true; // 上書きモードフラグ
    const storageKey = 'kyowa_80_dist_unified_v7';
    
    const inputs = {
        'main-input-80': '',
        'main-input-80leg': '',
        'leg-input-80leg': '',
        'dist-input-b': '',
        'dist-input-h': '',
        'dist-input-a': ''
    };

    let histories = JSON.parse(localStorage.getItem(storageKey)) || [];

    const elbowData = { 75: { d: 30, e: 82 }, 100: { d: 40, e: 103 }, 125: { d: 50, e: 130 } };
    const legConstants = { "75": 45, "100": 57, "125": 70 };
    const cos10 = Math.cos(10 * Math.PI / 180);

    function focusInput(id) {
        let internalId = id;
        if (id === 'main-input') internalId = `main-input-${currentTab}`;
        if (id === 'leg-input') internalId = `leg-input-${currentTab}`;
        
        document.querySelectorAll('.calc-cell').forEach(el => el.classList.remove('focused'));
        
        const targetId = (id.startsWith('main-input')) ? 'main-input' : (id.startsWith('leg-input') ? 'leg-input' : id);
        const target = document.getElementById(targetId);
        
        if (target) {
            target.closest('.calc-cell').classList.add('focused');
            focusedInputId = internalId;
            isOverwriteMode = true; // セル選択時に上書きモードを有効化
        }

        const enterLabel = document.getElementById('enter-btn-label');
        if (currentTab === '80leg') {
            enterLabel.innerText = (focusedInputId === 'leg-input-80leg') ? '⏎' : '保存';
        } else if (currentTab === 'dist') {
            enterLabel.innerText = (focusedInputId === 'dist-input-a') ? 'コピー' : '⏎';
        } else {
            enterLabel.innerText = '保存';
        }
    }

    function pressKey(key) {
        let val = inputs[focusedInputId] || '';
        
        if (key === 'clear') {
            val = '';
            isOverwriteMode = true;
        } else if (key === 'backspace') {
            if (currentTab === 'dist') { 
                clearDistFields(); 
                return; 
            } else { 
                val = val.toString().slice(0, -1); 
                isOverwriteMode = false;
            }
        } else if (key === 'enter') {
            handleEnter(); return;
        } else {
            // 上書きまたは追加のロジック
            if (isOverwriteMode) {
                if (key === '.') val = '0.';
                else val = key;
                isOverwriteMode = false;
            } else {
                if (key === '.') {
                    if (!val.toString().includes('.')) val += val === '' ? '0.' : '.';
                } else {
                    if (val === '0') val = key;
                    else val += key;
                }
            }
        }
        
        inputs[focusedInputId] = val;
        const displayTarget = (focusedInputId.startsWith('main-input')) ? 'main-input' : (focusedInputId.startsWith('leg-input') ? 'leg-input' : focusedInputId);
        updateDisplay(displayTarget, val);
        
        if (currentTab === 'dist') distCalc();
        else elbowCalc();
    }

    function clearDistFields() {
        ['dist-input-b', 'dist-input-h', 'dist-input-a'].forEach(id => { inputs[id] = ''; updateDisplay(id, ''); });
        distCalc();
        showToast("入力をクリアしました");
        isOverwriteMode = true;
    }

    function handleEnter() {
        if (currentTab === '80leg') {
            if (focusedInputId === 'leg-input-80leg') focusInput('main-input');
            else saveHistory();
        } else if (currentTab === '80') {
            saveHistory();
        } else if (currentTab === 'dist') {
            if (focusedInputId === 'dist-input-b') focusInput('dist-input-h');
            else if (focusedInputId === 'dist-input-h') focusInput('dist-input-a');
            else if (focusedInputId === 'dist-input-a') {
                copyResult();
            }
        }
    }

    function updateDisplay(id, val) {
        const el = document.getElementById(id);
        if (!el) return;
        if (val === '' || val === null) { el.innerText = '0'; el.style.opacity = '0.3'; }
        else { el.innerText = formatNum(val); el.style.opacity = '1'; }
    }

    function formatNum(num) {
        if (!num && num !== 0) return "";
        const parts = num.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
    }

    function switchTab(tabId) {
        if (tabId === currentTab) return;
        currentTab = tabId;
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`nav-${tabId}`).classList.add('active');
        
        const sectionElbow = document.getElementById('section-elbow');
        const sectionDist = document.getElementById('section-dist');
        const diagWrapper = document.getElementById('dist-diagram-wrapper');
        const historyWrapper = document.getElementById('history-content-wrapper');
        const deleteBtn = document.getElementById('delete-btn-label');
        
        const cellMain = document.getElementById('cell-main-input');
        const cellLeg = document.getElementById('cell-leg-input');

        document.body.className = `mode-${tabId}`;

        if (tabId === 'dist') {
            sectionElbow.classList.add('hidden');
            sectionDist.classList.remove('hidden');
            diagWrapper.classList.remove('hidden');
            historyWrapper.classList.add('hidden');
            deleteBtn.innerText = 'クリア';
            document.getElementById('result-label').innerText = "芯-芯寸法";
            focusInput('dist-input-b');
            distCalc();
        } else {
            sectionElbow.classList.remove('hidden');
            sectionDist.classList.add('hidden');
            diagWrapper.classList.add('hidden');
            historyWrapper.classList.remove('hidden');
            deleteBtn.innerText = '⇦';
            document.getElementById('result-label').innerText = "切寸法";
            
            if (tabId === '80leg') {
                cellMain.classList.remove('span-6');
                cellMain.classList.add('span-4');
                cellLeg.style.display = 'flex';
                cellLeg.classList.add('span-2');
                updateDisplay('leg-input', inputs[`leg-input-${tabId}`]);
            } else {
                cellMain.classList.remove('span-4');
                cellMain.classList.add('span-6');
                cellLeg.style.display = 'none';
            }
            
            updateDisplay('main-input', inputs[`main-input-${tabId}`]);
            focusInput(tabId === '80leg' ? 'leg-input' : 'main-input');
            elbowCalc();
            renderHistory();
        }
    }

    function elbowCalc() {
        const size = document.getElementById('elbow-size').value;
        const { d, e } = elbowData[size];
        document.getElementById('d-val').innerText = d;
        const inputVal = parseFloat(inputs[`main-input-${currentTab}`]);
        const resultEl = document.getElementById('result-val');
        if (!inputVal) { resultEl.innerText = "---"; return; }
        let f;
        if (currentTab === '80') f = (inputVal / cos10) - ((e - d) * 2);
        else {
            const legVal = parseFloat(inputs[`leg-input-${currentTab}`]) || 0;
            const c = inputVal - (legVal + legConstants[size]);
            f = (c / cos10) - ((e - d) * 2);
        }
        resultEl.innerText = formatNum(Math.ceil(f));
    }

    function distCalc() {
        const b = parseFloat(inputs['dist-input-b']) || 0;
        const h = parseFloat(inputs['dist-input-h']);
        const a = parseFloat(inputs['dist-input-a']);
        const x = parseFloat(document.getElementById('dist-select-x').value);
        const resValEl = document.getElementById('result-val');
        const diagResEl = document.getElementById('dist-diagram-result');
        if (isNaN(h) || isNaN(a)) {
            resValEl.innerText = "---";
            if(diagResEl) diagResEl.textContent = "---";
            return;
        }
        const A = h - (b + x);
        const resultSq = (A * A) + (a * a);
        if (resultSq < 0) {
            resValEl.innerText = "エラー";
            if(diagResEl) diagResEl.textContent = "ERR";
        } else {
            const res = Math.ceil(Math.sqrt(resultSq));
            resValEl.innerText = formatNum(res);
            if(diagResEl) diagResEl.textContent = formatNum(res);
        }
    }

    function saveHistory() {
        const inputKey = `main-input-${currentTab}`;
        const inputStr = formatNum(inputs[inputKey]);
        const result = document.getElementById('result-val').innerText;
        const sizeEl = document.getElementById('elbow-size');
        const sizeStr = sizeEl.options[sizeEl.selectedIndex].text;
        if (result === "---" || !inputs[inputKey]) return;
        const nonLockedCount = histories.filter(h => h.mode === currentTab && !h.locked).length;
        if (nonLockedCount >= 10) {
            const oldestIdx = histories.findIndex(h => h.mode === currentTab && !h.locked);
            if (oldestIdx !== -1) histories.splice(oldestIdx, 1);
        }
        histories.push({
            id: Date.now(), mode: currentTab, size: sizeStr, input: inputStr,
            leg: (currentTab === '80leg' ? formatNum(inputs[`leg-input-${currentTab}`]) : null),
            result, locked: false
        });
        localStorage.setItem(storageKey, JSON.stringify(histories));
        inputs[inputKey] = '';
        if(currentTab === '80leg') inputs[`leg-input-${currentTab}`] = '';
        updateDisplay('main-input', '');
        updateDisplay('leg-input', '');
        elbowCalc();
        renderHistory();
        showToast("保存しました");
        isOverwriteMode = true; // 保存後、次の入力は新しい値から開始
        if(currentTab === '80leg') focusInput('leg-input');
        else focusInput('main-input');
    }

    function toggleLock(id) {
        const item = histories.find(h => h.id === id);
        if (item) {
            item.locked = !item.locked;
            localStorage.setItem(storageKey, JSON.stringify(histories));
            renderHistory();
        }
    }

    function renderHistory() {
        if (currentTab === 'dist') return;
        const listEl = document.getElementById('main-history-list');
        listEl.innerHTML = "";
        const filtered = histories.filter(h => h.mode === currentTab).sort((a, b) => (b.locked - a.locked) || (b.id - a.id));
        if (!filtered.length) {
            listEl.innerHTML = '<div class="text-center py-4 text-zinc-800 text-[11px] font-bold">履歴はありません</div>';
            return;
        }
        filtered.forEach(item => {
            const div = document.createElement('div');
            div.className = `history-item ${item.locked ? 'is-locked' : ''}`;
            const lockIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;
            const legText = item.leg ? ` 足:${item.leg}` : "";
            div.innerHTML = `
                <button onclick="toggleLock(${item.id})" class="lock-btn ${item.locked ? 'active' : 'text-zinc-500'}">${lockIcon}</button>
                <div class="flex flex-col flex-1">
                    <span class="text-[14px] font-bold" style="color: var(--ios-silver)">${item.size} / 寸:${item.input}${legText}</span>
                    <span class="font-black text-2xl">${item.result}</span>
                </div>
                <button onclick="copyRaw('${item.result}')" class="p-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2.5"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                </button>`;
            listEl.appendChild(div);
        });
    }

    function clearHistory() {
        histories = histories.filter(h => h.mode !== currentTab || h.locked);
        localStorage.setItem(storageKey, JSON.stringify(histories));
        renderHistory();
        showToast("未保護の履歴を削除しました");
    }

    function copyResult() { copyRaw(document.getElementById('result-val').innerText); }
    function copyRaw(val) {
        if (val === "---" || val === "エラー") return;
        const cleanVal = val.replace(/,/g, "");
        const temp = document.createElement('textarea');
        temp.value = cleanVal;
        document.body.appendChild(temp);
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
        showToast("コピーしました");
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        if(t) {
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1000);
        }
    }

    window.onload = () => { focusInput('main-input'); elbowCalc(); renderHistory(); };
</script>
</body>
</html>