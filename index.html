<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>80エルボ計算 統合ダーク版</title>

<style>
:root {
    --ios-bg: #000000;
    --ios-card: #1c1c1e;
    --ios-input: #2c2c2e;
    --ios-input-border: #3a3a3c;
    --ios-secondary-text: #aeaeb2;
    --ios-placeholder: #636366;
    --ios-orange: #e68a00;
    --ios-orange-dark: #995c00;
    --ios-orange-light: #ffaa33;
    
    /* モード別カラー */
    --accent-purple: #af52de;
    --accent-blue: #007aff;
}

* {
    box-sizing: border-box;
    -webkit-text-size-adjust: 100%;
}

body {
    margin: 0;
    background: var(--ios-bg);
    font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    display: flex;
    justify-content: center;
    padding: 10px 6px;
    color: #ffffff;
    touch-action: pan-y;
}

.card {
    width: 100%;
    max-width: 420px;
    background: var(--ios-card);
    border-radius: 24px;
    padding: 20px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    display: flex;
    flex-direction: column;
    position: relative;
    user-select: none;
}

input, select { user-select: auto; }

.tab-container {
    display: flex;
    background: linear-gradient(180deg, #161618 0%, #2c2c2e 100%);
    padding: 3px;
    border-radius: 12px;
    margin-bottom: 20px;
    border: 1px solid #38383a;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.05);
}

.tab-btn {
    flex: 1;
    padding: 12px 4px;
    border: none;
    border-radius: 9px;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    background: transparent;
    color: #8e8e93;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    line-height: 1.2;
}

.tab-btn.active {
    background: linear-gradient(180deg, #636366 0%, #48484a 100%);
    color: white;
    box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
}

.header { text-align: center; margin-bottom: 20px; }

/* タイトル色の動的変更 */
.title { font-size: 24px; font-weight: 700; margin: 0; transition: color 0.3s ease; }
.mode-80 .title { color: var(--accent-purple); }
.mode-80-leg .title { color: var(--accent-blue); }

.subtitle { font-size: 14px; color: #8e8e93; letter-spacing: 0.15em; font-weight: 600; margin-top: 4px; }

.result-display-box {
    border: none;
    transition: background 0.3s ease, box-shadow 0.3s ease;
    height: 104px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin-top: 16px;
    border-radius: 20px;
}

.mode-80 .result-display-box { 
    background: var(--accent-purple); 
    box-shadow: 0 10px 20px rgba(175, 82, 222, 0.4); 
}
.mode-80-leg .result-display-box { 
    background: var(--accent-blue); 
    box-shadow: 0 10px 20px rgba(0, 122, 255, 0.4); 
}

.label-inside { font-size: 15px; font-weight: 700; margin-bottom: 2px; }
.result-value-text { font-size: 40px; font-weight: 900; display: flex; align-items: baseline; gap: 4px; }
.result-unit-text { font-size: 18px; font-weight: 700; opacity: 0.9; }

.input-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
.size-row { display: flex; gap: 10px; }
.input-container { display: flex; flex-direction: column; gap: 6px; flex: 1; position: relative; }
.label-outside { font-size: 14px; font-weight: 700; color: #aeaeb2; margin-left: 8px; }

.input-box {
    width: 100%;
    height: 54px;
    background: var(--ios-input);
    border-radius: 14px;
    border: 1.5px solid #444446;
    display: flex;
    align-items: center;
    position: relative;
    overflow: hidden;
    transition: border 0.3s ease;
}

.input-box.large { height: 70px; border-radius: 18px; background: #121214; }
.static-box { background: #121214; border: 1.5px solid #48484a; }

.mode-80 .accent-border { border: 2.5px solid var(--accent-purple); }
.mode-80-leg .accent-border { border: 2.5px solid var(--accent-blue); }

.select, .input {
    width: 100%; background: transparent; border: none; color: #ffffff; text-align: center; outline: none;
}
.select { font-size: 24px; font-weight: 800; -webkit-appearance: none; cursor: pointer; }
.input { font-size: 34px; font-weight: 900; }
.input.small-input { font-size: 24px; }

.static-value { width: 100%; color: #aeaeb2; display: flex; justify-content: center; align-items: baseline; gap: 2px; font-size: 24px; font-weight: 800; }
.static-unit { font-size: 15px; font-weight: 600; }

/* 足付の時の中間計算結果表示 */
.intermediate-display {
    text-align: center;
    font-size: 14px; /* 13pxから14pxへ変更 */
    font-weight: 700;
    color: var(--accent-blue);
    margin-top: 4px;
    min-height: 1.2em;
    opacity: 0.8;
    display: none;
}
.mode-80-leg .intermediate-display { display: block; }

.save-btn {
    width: 100%; 
    height: 44px; 
    color: #ffffff; 
    border: none; 
    border-radius: 14px; 
    font-size: 16px; 
    font-weight: 900;
    margin-bottom: 28px; 
    position: relative;
    top: 0;
    transition: all 0.1s ease;
    background: linear-gradient(180deg, var(--ios-orange-light) 0%, var(--ios-orange) 100%);
    box-shadow: 0 4px 0 var(--ios-orange-dark), 0 8px 15px rgba(0,0,0,0.5); 
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.save-btn:active { top: 3px; box-shadow: 0 1px 0 var(--ios-orange-dark), 0 3px 10px rgba(0,0,0,0.4); }
.save-btn:disabled { background: #2c2c2e !important; color: #48484a; box-shadow: none !important; top: 0 !important; cursor: default; }
.save-btn.success { background: linear-gradient(180deg, #34c759 0%, #248a3d 100%); box-shadow: 0 4px 0 #1a632c, 0 8px 15px rgba(0,0,0,0.5); }

.history-section { border-top: 1px solid #38383a; padding-top: 16px; }
.history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.history-title { font-size: 14px; font-weight: 700; color: #8e8e93; }
.history-clear-all { font-size: 14px; color: #ff453a; cursor: pointer; background: none; border: none; font-weight: 700; }
.history-list { display: flex; flex-direction: column; gap: 4px; }

.history-item {
    background: var(--ios-input); border-radius: 14px; padding: 6px 12px; 
    display: flex; justify-content: space-between; align-items: center; border: 1px solid #3a3c3e;
}
.history-info { font-size: 14px; color: #d1d1d6; display: flex; align-items: center; gap: 6px; }
.history-size-tag { 
    background: rgba(255, 159, 10, 0.1); padding: 1px 6px; border-radius: 6px; 
    font-weight: 700; border: 1px solid var(--ios-orange); font-size: 12px;
}
.btn-save-mark { color: var(--ios-orange); font-size: 16px; font-weight: bold; margin-right: 4px; }
.history-result { font-size: 19px; font-weight: 900; }
.history-delete { color: #ff453a; cursor: pointer; font-size: 26px; font-weight: bold; margin-left: 10px; line-height: 1; }

.modal-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); backdrop-filter: blur(4px);
    display: none; justify-content: center; align-items: center;
    z-index: 100; border-radius: 24px;
}
.modal-content { background: #2c2c2e; width: 85%; padding: 24px; border-radius: 20px; text-align: center; }
.modal-btns { display: flex; gap: 12px; margin-top: 20px; }
.modal-btn { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; font-size: 16px; cursor: pointer; }
.modal-btn-cancel { background: #48484a; color: white; }
.modal-btn-confirm { background: #ff453a; color: white; }

.footer { text-align: center; margin-top: 24px; font-size: 12px; color: #8e8e93; letter-spacing: 0.05em; font-weight: 600; }

.mode-80 #main-input-label { color: var(--accent-purple); }
.mode-80-leg #main-input-label { color: var(--accent-blue); }

/* 足寸法コンテナの表示制御 */
#leg-input-container { display: none; }
.mode-80-leg #leg-input-container { display: flex; }
</style>
</head>

<body class="mode-80">

<div class="card" id="main-card">
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div style="font-size: 18px; font-weight: 700; margin-bottom: 12px;">履歴の削除</div>
            <div id="modal-msg">履歴を全て削除してもよろしいですか？</div>
            <div class="modal-btns">
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">キャンセル</button>
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">削除する</button>
            </div>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab-btn active" data-mode="80">80°エルボ</button>
        <button class="tab-btn" data-mode="80-leg">足付 80°エルボ</button>
    </div>

    <div class="header">
        <div class="title" id="page-title">80°エルボ 計算</div>
        <div class="subtitle">KYOWA ROOF</div>

        <div class="result-display-box">
            <div class="label-inside" id="result-label" style="color: #ffffff;">切寸法</div>
            <div class="result-value-text">
                <span id="result">---</span>
                <span class="result-unit-text">mm</span>
            </div>
        </div>
    </div>

    <div class="input-group">
        <div class="size-row">
            <div class="input-container">
                <div class="label-outside">サイズ</div>
                <div class="input-box accent-border">
                    <select id="size" class="select">
                        <option value="75">75</option>
                        <option value="100" selected>100</option>
                        <option value="125">125</option>
                    </select>
                </div>
            </div>
            <div class="input-container" id="leg-input-container">
                <div class="label-outside">足寸法</div>
                <div class="input-box accent-border">
                    <input id="leg-input" class="input small-input" type="text" inputmode="decimal" placeholder="0">
                </div>
            </div>
            <div class="input-container" id="d-container">
                <div class="label-outside">重寸法</div>
                <div class="input-box static-box">
                    <div class="static-value"><span id="d">--</span><span class="static-unit">mm</span></div>
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="label-outside" id="main-input-label">寸法 (mm)</div>
            <div class="input-box large accent-border" id="input-box-large">
                <input id="input" class="input" type="text" inputmode="decimal" placeholder="0">
            </div>
            <!-- 足付時の中間計算表示エリア -->
            <div id="intermediate-val" class="intermediate-display"></div>
        </div>
    </div>

    <button id="save-btn" class="save-btn" disabled>★履歴に保存</button>

    <div class="history-section">
        <div class="history-header">
            <span class="history-title">保存された履歴</span>
            <button id="history-clear-all" class="history-clear-all">履歴をクリア</button>
        </div>
        <div id="history-list" class="history-list"></div>
    </div>

    <div class="footer" id="footer-text">★：ボタン保存（無制限） / 自動保存（3件）</div>
</div>

<script>
const data = {
    "80": { 75: { d: 30, e: 82 }, 100: { d: 40, e: 103 }, 125: { d: 50, e: 130 } },
    "80-leg": { 75: { d: 30, e: 82 }, 100: { d: 40, e: 103 }, 125: { d: 50, e: 130 } }
};

const sizeConstants = { "75": 45, "100": 57, "125": 70 };

const storageKey = 'kyowa_elbow_integrated_v8';
let currentMode = "80";
let histories = JSON.parse(localStorage.getItem(storageKey)) || [];
let currentCalculatedResult = null;
let lastSavedTimestamp = 0;

const tabStates = {
    "80": { input: "", leg: "", size: "100" },
    "80-leg": { input: "", leg: "", size: "100" }
};

const elements = {
    body: document.body,
    tabBtns: document.querySelectorAll(".tab-btn"),
    pageTitle: document.getElementById("page-title"),
    resultLabel: document.getElementById("result-label"),
    mainInputLabel: document.getElementById("main-input-label"),
    sizeEl: document.getElementById("size"),
    inputEl: document.getElementById("input"),
    legInputEl: document.getElementById("leg-input"),
    saveBtn: document.getElementById("save-btn"),
    dEl: document.getElementById("d"),
    resultEl: document.getElementById("result"),
    cValueEl: document.getElementById("intermediate-val"),
    historyListEl: document.getElementById("history-list"),
    clearAllBtn: document.getElementById("history-clear-all"),
    modal: document.getElementById("modal-overlay"),
    modalMsg: document.getElementById("modal-msg"),
    modalCancel: document.getElementById("modal-cancel"),
    modalConfirm: document.getElementById("modal-confirm")
};

function formatNumber(num) {
    if (num === null || isNaN(num)) return "---";
    const parts = num.toString().split(".");
    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    return parts.join(".");
}

function unformatNumber(str) { return str.replace(/,/g, ""); }

function switchMode(mode) {
    if (mode === currentMode) return;
    tabStates[currentMode].input = elements.inputEl.value;
    tabStates[currentMode].leg = elements.legInputEl.value;
    tabStates[currentMode].size = elements.sizeEl.value;

    currentMode = mode;
    elements.tabBtns.forEach(b => b.classList.toggle("active", b.dataset.mode === mode));
    elements.body.className = `mode-${mode}`;
    
    const titleMap = { "80": "80°エルボ", "80-leg": "足付 80°エルボ" };
    elements.pageTitle.textContent = `${titleMap[mode]} 計算`;
    
    elements.inputEl.value = tabStates[currentMode].input;
    elements.legInputEl.value = tabStates[currentMode].leg;
    elements.sizeEl.value = tabStates[currentMode].size;
    
    calc();
    renderHistory();
}

function calc() {
    const size = elements.sizeEl.value;
    let valStr = elements.inputEl.value;
    let rawInput = unformatNumber(valStr).replace(/[^\d.]/g, "");
    if (rawInput !== "") {
        const parts = rawInput.split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        elements.inputEl.value = parts.join(".");
    }

    const { d, e } = data[currentMode][size];
    elements.dEl.textContent = d;

    const inputVal = parseFloat(rawInput);
    if (isNaN(inputVal)) {
        elements.resultEl.textContent = "---";
        elements.cValueEl.textContent = "";
        elements.saveBtn.disabled = true;
        currentCalculatedResult = null;
        return;
    }

    let f, resultFormatted;
    const cos10 = Math.cos(10 * Math.PI / 180);

    if (currentMode === "80") {
        f = (inputVal / cos10) - ((e - d) * 2);
        resultFormatted = formatNumber(Math.ceil(f));
        elements.cValueEl.textContent = "";
    } else if (currentMode === "80-leg") {
        const legValStr = unformatNumber(elements.legInputEl.value);
        const legVal = parseFloat(legValStr);
        if (isNaN(legVal) || legValStr === "") {
            elements.resultEl.textContent = "---";
            elements.cValueEl.textContent = "";
            elements.saveBtn.disabled = true;
            return;
        }
        const constVal = sizeConstants[size];
        const c = inputVal - (legVal + constVal);
        
        // ラベル名を「寸法 (芯-芯)」に変更
        elements.cValueEl.textContent = `寸法 (芯-芯): ${formatNumber(Math.round(c * 10) / 10)} mm`;
        
        f = (c / cos10) - ((e - d) * 2);
        resultFormatted = formatNumber(Math.ceil(f));
    }
    
    elements.resultEl.textContent = resultFormatted;
    elements.saveBtn.disabled = false;
    currentCalculatedResult = { 
        mode: currentMode, size, 
        input: elements.inputEl.value, 
        leg: currentMode === "80-leg" ? elements.legInputEl.value : null,
        result: resultFormatted 
    };
}

function renderHistory() {
    elements.historyListEl.innerHTML = "";
    const filtered = histories.filter(item => item.mode === currentMode);
    if (filtered.length === 0) {
        elements.historyListEl.innerHTML = '<div style="text-align:center; padding:15px; color:#48484a; font-size:12px;">履歴はありません</div>';
        return;
    }
    [...filtered].reverse().forEach((item) => {
        const div = document.createElement("div");
        div.className = "history-item";
        const legText = item.leg ? ` 足:${item.leg}` : "";
        const markHtml = item.method === 'button' ? '<span class="btn-save-mark">★</span>' : '';
        div.innerHTML = `
            <div class="history-info">
                ${markHtml}
                <span class="history-size-tag">${item.size}</span>
                <span>寸:${item.input}${legText}</span>
            </div>
            <div style="display: flex; align-items: center;">
                <span class="history-result">${item.result}</span>
                <span class="history-delete" data-ts="${item.timestamp}">×</span>
            </div>
        `;
        elements.historyListEl.appendChild(div);
    });
    elements.historyListEl.querySelectorAll(".history-delete").forEach(btn => {
        btn.onclick = () => {
            const ts = parseInt(btn.getAttribute("data-ts"));
            histories = histories.filter(h => h.timestamp !== ts);
            localStorage.setItem(storageKey, JSON.stringify(histories));
            renderHistory();
        };
    });
}

function saveToHistory(method = 'enter') {
    const now = Date.now();
    if (now - lastSavedTimestamp < 300 || !currentCalculatedResult) return;
    if (method === 'enter') {
        const autos = histories.filter(h => h.mode === currentMode && h.method === 'enter');
        if (autos.length >= 3) {
            const oldestIdx = histories.findIndex(h => h.mode === currentMode && h.method === 'enter');
            if (oldestIdx !== -1) histories.splice(oldestIdx, 1);
        }
    }
    histories.push({ ...currentCalculatedResult, timestamp: now, method: method });
    if (histories.length > 500) histories.shift();
    localStorage.setItem(storageKey, JSON.stringify(histories));
    renderHistory();
    lastSavedTimestamp = now;
    
    if (method === 'button') {
        elements.saveBtn.classList.add("success");
        setTimeout(() => elements.saveBtn.classList.remove("success"), 800);
    }
}

elements.saveBtn.onclick = () => saveToHistory('button');
elements.inputEl.oninput = calc;
elements.legInputEl.oninput = calc;
elements.sizeEl.onchange = () => { calc(); setTimeout(() => elements.inputEl.focus(), 100); };
elements.tabBtns.forEach(btn => btn.onclick = () => switchMode(btn.dataset.mode));
elements.clearAllBtn.onclick = () => { 
    elements.modalMsg.textContent = `現在の「${elements.pageTitle.textContent.replace(' 計算', '')}」の履歴を全てクリアしますか？`;
    elements.modal.style.display = "flex"; 
};
elements.modalCancel.onclick = () => { elements.modal.style.display = "none"; };
elements.modalConfirm.onclick = () => {
    histories = histories.filter(item => item.mode !== currentMode);
    localStorage.setItem(storageKey, JSON.stringify(histories));
    renderHistory();
    elements.modal.style.display = "none";
};

[elements.inputEl, elements.legInputEl].forEach(el => {
    el.onkeydown = (e) => {
        if (e.key === "Enter") {
            if (!elements.saveBtn.disabled) saveToHistory('enter');
            el.blur();
        }
    }
    el.onblur = () => {
        if (!elements.saveBtn.disabled && el.value !== "" && el.value !== "0") {
            if(currentCalculatedResult) saveToHistory('enter');
        }
    };
});

window.onload = () => { calc(); renderHistory(); };
</script>
</body>
</html>